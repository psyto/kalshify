// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Company model - Index data storage
model Company {
  id              String   @id @default(cuid())
  slug            String   @unique
  name            String
  category        String   // 'defi' | 'nft' | 'gaming' | 'infrastructure' | 'dao'
  description     String?  @db.Text
  logo            String?
  website         String?

  // Scores (cached from calculations)
  overallScore    Int      @default(0)
  teamHealthScore Int      @default(0)
  growthScore     Int      @default(0)
  socialScore     Int      @default(0)
  walletQualityScore Int   @default(0)

  // Trend indicator
  trend           String   @default("stable") // 'up' | 'stable' | 'down'

  // Raw Index data (JSON)
  // Stores full IndexData from APIs
  indexData Json?

  // Status
  isListed        Boolean  @default(false)
  isActive        Boolean  @default(true)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastFetchedAt   DateTime?

  @@index([slug])
  @@index([category])
  @@index([overallScore])
  @@index([isActive])
}

// User model - Extended for NextAuth + Web3
model User {
  id              String   @id @default(cuid())

  // NextAuth fields
  name            String?
  email           String?  @unique
  emailVerified   DateTime?
  image           String?

  // Web3 wallet (optional, for wallet login)
  walletAddress   String?  @unique

  // Optional profile fields
  displayName     String?
  bio             String?
  website         String?
  twitter         String?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastLoginAt     DateTime?

  // Relations
  listings        Listing[]
  offers          Offer[]
  dataRoomRequests DataRoomRequest[]
  watchlist       Watchlist[]
  notifications   Notification[]

  // New: Partnership matching relations
  accounts        Account[]
  sessions        Session[]
  claimedProfiles ClaimedProfile[]
  swipes          Swipe[]

  @@index([walletAddress])
  @@index([email])
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Claimed Profile - Links users to companies
model ClaimedProfile {
  id                  String   @id @default(cuid())

  // Link to user and company
  userId              String
  companySlug         String   @unique  // Each company can only be claimed once

  // Verification
  verificationType    String   // 'domain' | 'github' | 'wallet'
  verificationProof   String?  // Proof of verification (TXT record, GitHub commit, signature)
  verified            Boolean  @default(false)
  verifiedAt          DateTime?

  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companySlug])
}

// Swipe - Track partnership interest
model Swipe {
  id            String   @id @default(cuid())

  // Who swiped
  userId        String
  companySlug   String   // The user's company

  // Who they swiped on
  partnerSlug   String   // The partner company

  // Action
  action        String   // 'interested' | 'passed' | 'super_like'

  // Timestamps
  createdAt     DateTime @default(now())

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Prevent duplicate swipes
  @@unique([companySlug, partnerSlug])
  @@index([userId])
  @@index([companySlug])
  @@index([partnerSlug])
}

// Match - Mutual partnership interest
model Match {
  id            String   @id @default(cuid())

  // The two companies that matched
  companyASlug  String
  companyBSlug  String

  // Match metadata
  matchScore    Int      // AI compatibility score (0-100)

  // Status
  status        String   @default("new")  // 'new' | 'chatting' | 'partnership_started' | 'completed' | 'declined'

  // Timestamps
  matchedAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Partnership tracking (optional)
  partnershipType String?  // 'integration' | 'co-marketing' | 'merger' | 'revenue_share'
  partnershipMetrics Json?   // Track KPIs (revenue, users, etc.)

  // Relations
  conversation  Conversation?

  // Prevent duplicate matches (A-B is same as B-A)
  @@unique([companyASlug, companyBSlug])
  @@index([companyASlug])
  @@index([companyBSlug])
  @@index([status])
  @@index([matchedAt])
}

// Conversation - Chat between matched companies
model Conversation {
  id        String    @id @default(cuid())
  matchId   String    @unique
  match     Match     @relation(fields: [matchId], references: [id], onDelete: Cascade)
  messages  Message[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([matchId])
}

// Message - Individual messages in a conversation
model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderSlug     String       // companySlug of sender
  content        String       @db.Text
  read           Boolean      @default(false)
  createdAt      DateTime     @default(now())

  @@index([conversationId, createdAt])
  @@index([senderSlug])
}

// Listing model - Matches existing mock data structure
model Listing {
  id              String   @id @default(cuid())

  // Basic Info
  type            String   // 'acquisition' | 'partnership' | 'collaboration' | 'investment'
  projectName     String
  productType     String
  description     String   @db.Text

  // M&A Fields (optional)
  askingPrice     Decimal?  @db.Decimal(15, 2)
  revenue         Decimal   @db.Decimal(15, 2)
  mau             Int

  // Partnership Fields (optional)
  seekingPartners     String[]
  offeringCapabilities String[]
  partnershipType     String?   // 'technical' | 'strategic' | 'marketing' | 'ecosystem'

  // Metadata
  category        String   // 'defi' | 'nft' | 'gaming' | 'infrastructure' | 'dao'
  status          String   @default("active") // 'active' | 'under_offer' | 'sold' | 'withdrawn' | 'in_discussion'
  chain           String   // 'ethereum' | 'base' | 'polygon' | 'solana' | 'multi-chain'
  website         String?
  logoUrl         String?  // Supabase Storage URL

  // Requirements
  hasNDA          Boolean  @default(false)
  requiresProofOfFunds Boolean @default(false)
  minBuyerCapital Decimal?  @db.Decimal(15, 2)

  // Index Link (optional)
  indexCompanyId String?
  suiteDataSnapshot     Json?    // Cached PULSE + TRACE data

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  // Relations
  seller          User     @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  sellerId        String

  offers          Offer[]
  dataRoomRequests DataRoomRequest[]
  documents       Document[]
  watchlist       Watchlist[]

  @@index([sellerId])
  @@index([status])
  @@index([category])
  @@index([type])
  @@index([createdAt])
}

// Offer model - Buyer offers on listings
model Offer {
  id              String   @id @default(cuid())

  // Offer Details
  amount          Decimal?  @db.Decimal(15, 2)  // For M&A
  proposalText    String   @db.Text             // For both M&A and partnerships

  // Status
  status          String   @default("pending")  // 'pending' | 'accepted' | 'rejected' | 'withdrawn'

  // Contact Info (optional)
  contactEmail    String?
  contactTelegram String?

  // Proof of Funds
  proofOfFundsUrl String?  // Supabase Storage URL

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  respondedAt     DateTime?

  // Relations
  listing         Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId       String

  buyer           User     @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  buyerId         String

  @@index([listingId])
  @@index([buyerId])
  @@index([status])
  @@index([createdAt])
}

// Data Room Request model - Buyers requesting access to private documents
model DataRoomRequest {
  id              String   @id @default(cuid())

  // Request Details
  purpose         String   @db.Text
  companyName     String?
  position        String?

  // Status
  status          String   @default("pending")  // 'pending' | 'approved' | 'rejected'

  // NDA
  ndaSigned       Boolean  @default(false)
  ndaSignedAt     DateTime?
  ndaDocumentUrl  String?  // Supabase Storage URL

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  respondedAt     DateTime?

  // Relations
  listing         Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId       String

  requester       User     @relation(fields: [requesterId], references: [id], onDelete: Cascade)
  requesterId     String

  @@index([listingId])
  @@index([requesterId])
  @@index([status])
}

// Document model - File metadata for listings
model Document {
  id              String   @id @default(cuid())

  // Document Info
  name            String
  url             String   // Supabase Storage URL
  type            String   // 'logo' | 'data_room' | 'proof_of_funds' | 'nda'
  sizeBytes       Int
  mimeType        String

  // Access Control
  requiresDataRoomAccess Boolean @default(false)

  // Timestamps
  createdAt       DateTime @default(now())

  // Relations
  listing         Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId       String

  @@index([listingId])
  @@index([type])
}

// Watchlist model - Users saving listings for later
model Watchlist {
  id              String   @id @default(cuid())

  // Timestamps
  createdAt       DateTime @default(now())

  // Relations (Composite unique to prevent duplicates)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String

  listing         Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId       String

  @@unique([userId, listingId])
  @@index([userId])
}

// Notification model - In-app notifications and email tracking
model Notification {
  id              String   @id @default(cuid())

  // Notification Content
  type            String   // 'new_offer' | 'data_room_request' | 'offer_response' | 'listing_status_change'
  title           String
  message         String   @db.Text

  // Link
  linkUrl         String?

  // Status
  read            Boolean  @default(false)
  emailSent       Boolean  @default(false)

  // Timestamps
  createdAt       DateTime @default(now())
  readAt          DateTime?

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}
