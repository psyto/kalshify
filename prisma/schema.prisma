// Kalshify - Prediction Market Analytics Platform
// Prisma Schema for Kalshi integration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User model - Extended for NextAuth + Web3
model User {
  id              String   @id @default(cuid())

  // NextAuth fields
  name            String?
  email           String?  @unique
  emailVerified   DateTime?
  image           String?

  // Web3 wallet (for Solana/DFlow integration)
  walletAddress   String?  @unique

  // Profile fields
  displayName     String?
  bio             String?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastLoginAt     DateTime?

  // NextAuth relations
  accounts        Account[]
  sessions        Session[]

  // Kalshify relations
  marketWatchlist     MarketWatchlist[]
  predictionPreferences UserPredictionPreferences?
  paperPositions      PaperPosition[]
  portfolioSnapshots  PortfolioSnapshot[]

  @@index([walletAddress])
  @@index([email])
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Market Watchlist - Users tracking Kalshi markets
model MarketWatchlist {
  id              String   @id @default(cuid())

  // Market identification (from Kalshi)
  marketId        String   // Kalshi market ticker
  eventTicker     String?  // Parent event ticker
  title           String   // Market title for display
  category        String?  // Market category

  // Timestamps
  createdAt       DateTime @default(now())

  // User relation
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String

  @@unique([userId, marketId])
  @@index([userId])
  @@index([marketId])
}

// User Prediction Preferences - AI recommendation settings
model UserPredictionPreferences {
  id                  String   @id @default(cuid())
  userId              String   @unique

  // Risk tolerance
  riskTolerance       String   @default("moderate") // "conservative" | "moderate" | "aggressive"

  // Category preferences
  preferredCategories String[] @default([]) // elections, weather, economics, crypto, sports, etc.

  // Probability range filters
  minProbability      Float    @default(0)  // 0-100
  maxProbability      Float    @default(100)

  // Volume preferences
  minVolume           Float?   // Minimum trading volume

  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Market Insight Cache - Cached AI-generated insights
model MarketInsightCache {
  id              String   @id @default(cuid())
  marketId        String   @unique

  // Cached insight content
  insight         Json     // AI analysis, key factors, etc.

  // Market snapshot for cache invalidation
  marketSnapshot  Json     // Price, volume at cache time

  // Timestamps
  generatedAt     DateTime @default(now())
  expiresAt       DateTime

  @@index([marketId])
  @@index([expiresAt])
}

// Paper Position - Simulated trading positions
model PaperPosition {
  id              String   @id @default(cuid())
  userId          String

  // Market info
  marketId        String   // Kalshi market ticker
  marketTitle     String   // Market title for display
  eventTicker     String?  // Parent event

  // Position details
  position        String   // "yes" | "no"
  quantity        Int      // Number of contracts
  entryPrice      Float    // Entry price (0-100 cents)

  // Status
  status          String   @default("open") // "open" | "closed"
  exitPrice       Float?   // Price when closed
  closedAt        DateTime?

  // P&L tracking
  realizedPnl     Float?   // Profit/loss when closed

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
  @@index([marketId])
}

// Portfolio Snapshot - Track portfolio performance over time
model PortfolioSnapshot {
  id              String   @id @default(cuid())
  userId          String

  // Portfolio metrics
  totalValue      Float    // Total portfolio value in cents
  totalCost       Float    // Total cost basis
  unrealizedPnl   Float    // Current unrealized P&L
  realizedPnl     Float    // Cumulative realized P&L

  // Position count
  openPositions   Int      // Number of open positions

  // Timestamp
  snapshotAt      DateTime @default(now())

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, snapshotAt])
}

// Market Category Cache - Cached category data
model MarketCategoryCache {
  id              String   @id @default(cuid())
  category        String   @unique

  // Cached data
  marketCount     Int
  totalVolume     Float
  topMarkets      Json     // Array of top market tickers

  // Timestamps
  updatedAt       DateTime @updatedAt

  @@index([category])
}

// Builder Code Metrics - Track DFlow builder code usage
model BuilderCodeMetrics {
  id              String   @id @default(cuid())

  // Daily metrics
  date            DateTime @db.Date

  // Volume tracking
  totalVolume     Float    @default(0)
  transactionCount Int     @default(0)
  uniqueUsers     Int      @default(0)

  // Fee tracking
  feesEarned      Float    @default(0)

  // Timestamps
  createdAt       DateTime @default(now())

  @@unique([date])
  @@index([date])
}
